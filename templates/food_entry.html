<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Приём пищи</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<main class="food-entry-container">

  <!-- ── тулбар: суммарно за день ── -->
  <header class="toolbar">
    <table class="summary-table">
      <tr>
        <td></td>  <!-- продукт -->
        <td></td>  <!-- qty -->
        <td>Ккал <strong>{{ totals.kcal }}</strong></td>
        <td>Б, г <strong>{{ totals.protein }}</strong></td>
        <td>Ж, г <strong>{{ totals.fat }}</strong></td>
        <td>У, г <strong>{{ totals.carbs }}</strong></td>
      </tr>
    </table>
  </header>

  <!-- левая панель -->
  <aside class="left-panel">
    <div class="block left-chart">
      <h3>Калории за день</h3>
      <div class="daily-chart-container">
        <canvas id="daily-chart" width="180" height="180"></canvas>
      </div>
          <!-- Новые строки под графиком -->
    <p class="chart-text">Потреблено: <strong>{{ totals.kcal }}</strong> Ккал</p>
    <p class="chart-text">Цель: <strong>{{ norm_cal }}</strong> Ккал</p>
      <!-- Новая кнопка добавления продукта -->
    <button class="back-btn"
            onclick="window.location='{{ url_for('product_db', next='food_entry') }}';">
      Добавить продукт
    </button>
      <button class="back-btn" onclick="location='{{ url_for('main') }}'">Назад</button>
    </div>
  </aside>

  <!-- три приёма пищи -->
  <section class="entry-content">
    {% for idx in (1,2,3) %}
    <section class="panel meal-panel{% if not meals[idx] %} empty-panel{% endif %}" data-meal="{{ idx }}">

      <header class="meal-header"><h3>Приём №{{ idx }}</h3></header>

      <div class="meal-body">

        <!-- мини‑сводка -->
        <table class="mini-summary-table">
          <tr>
            <td></td><td></td>
            <td>Ккал <strong>{{ meal_sums[idx].kcal }}</strong></td>
            <td>Б <strong>{{ meal_sums[idx].protein }}</strong></td>
            <td>Ж <strong>{{ meal_sums[idx].fat }}</strong></td>
            <td>У <strong>{{ meal_sums[idx].carbs }}</strong></td>
          </tr>
        </table>

        {% if meals[idx] %}
        <table class="meal-table">
          <thead>
            <tr>
              <th>Продукт</th><th>Кол‑во, г</th><th>Ккал</th>
              <th>Б, г</th><th>Ж, г</th><th>У, г</th><th style="width:10%"></th>
            </tr>
          </thead>
          <tbody>
            {% for row in meals[idx] %}
            <tr data-entry="{{ row.id }}">
              <td>{{ row.name }}</td>
              <td>{{ row.qty }}</td>
              <td>{{ row.kcal }}</td>
              <td>{{ row.protein }}</td>
              <td>{{ row.fat }}</td>
              <td>{{ row.carbs }}</td>
              <td><button class="del-btn">✕</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="empty">Нет продуктов</p>
        {% endif %}
      </div>
    </section>
    {% endfor %}
  </section>
</main>

<script>
  // Toggle only the clicked meal panel (and handle deletes)
  const container = document.querySelector('.entry-content');
  container.addEventListener('click', e => {
    // If delete button clicked, handle removal
    if (e.target.classList.contains('del-btn')) {
      e.stopPropagation();
      const row = e.target.closest('tr');
      fetch('/delete-food', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: row.dataset.entry})
      })
      .then(r => r.json())
      .then(d => { if (d.ok) window.location.reload(); })
      .catch(console.error);
      return;
    }
    // Toggle panel only if click happened inside it (not delete)
    const panel = e.target.closest('.meal-panel');
    if (panel) {
      panel.classList.toggle('open');
    }
  });
</script>
<script>
  (function() {
    const consumed = {{ totals.kcal }};
    const norm = {{ norm_cal }};
    const canvas = document.getElementById('daily-chart');
    if (!canvas || !norm) return;
    // High-DPI support
    const dpr = window.devicePixelRatio || 1;
    const size = canvas.clientWidth;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    const center = size / 2;
    const trackWidth = 16;
    const ringWidth = 16;
    const overflowWidth = 12;
    // Radii
    const trackRadius = center - trackWidth;
    const ringRadius = center - trackWidth;
    const overflowRadius = center - trackWidth - ringWidth - 4;
    // Draw background track
    ctx.lineWidth = trackWidth;
    ctx.strokeStyle = 'rgba(100,100,100,0.2)';
    ctx.beginPath();
    ctx.arc(center, center, trackRadius, 0, 2 * Math.PI, false);
    ctx.stroke();
    // Draw main ring
    const ratio = Math.min(consumed / norm, 1);
    const start = -0.5 * Math.PI;
    const end = start + ratio * 2 * Math.PI;
    ctx.lineWidth = ringWidth;
    ctx.strokeStyle = '#47BF21';
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.arc(center, center, ringRadius, start, end, false);
    ctx.stroke();
    // Draw overflow ring if any
    if (consumed > norm) {
      const over = Math.min((consumed - norm) / norm, 1);
      const overEnd = start + over * 2 * Math.PI;
      ctx.lineWidth = overflowWidth;
      ctx.strokeStyle = '#E14747';
      ctx.beginPath();
      ctx.arc(center, center, overflowRadius, start, overEnd, false);
      ctx.stroke();
    }
  })();
</script>
</body>
</html>